# 班赛直播系统 架构设计文档（5v5 · 推流专用）

> 适用范围：王者荣耀班赛直播包装系统（BP 全屏 / 比赛 Overlay / 结算全屏），
> 以 **人工后台录入 + 实时广播 + OBS 浏览器源展示** 为核心设计。

---

## 1. 架构设计目标

### 1.1 核心目标
- **低复杂度**：不依赖游戏数据抓取，完全人工可控
- **低延迟**：后台发布 → 前端展示 < 1s
- **高稳定性**：直播过程中不因单点失败影响画面
- **导播友好**：URL 固定、OBS 场景清晰

### 1.2 非目标（明确不做）
- 不对接王者荣耀官方数据接口
- 不做观众互动、弹幕、投票
- 不做手机端/响应式 UI

---

## 2. 总体架构概览

```
┌──────────────┐
│ 数据员浏览器 │  后台管理端（Web）
└──────┬───────┘
       │ REST API（录入/发布）
┌──────▼───────┐
│   应用服务    │  API + WebSocket
│  (Backend)   │
└──────┬───────┘
       │ WS 实时广播
┌──────▼────────────────────────────┐
│          前端展示页面（Web）        │
│  BP全屏 / 比赛Overlay / 结算全屏    │
└──────────────┬────────────────────┘
               │ 浏览器源
         ┌─────▼─────┐
         │    OBS     │
         └─────┬─────┘
               │ 推流
         ┌─────▼─────┐
         │  直播平台  │
         └───────────┘
```

---

## 3. 模块划分

### 3.1 后台管理端（Admin Web）

**职责**
- 人工录入 BP / 比赛结果 / MVP
- 控制“发布 / 锁定 / 回滚”

**主要页面**
- 登录页
- 比赛 Dashboard
- BP 编辑页
- 结算编辑页

**技术建议**
- 框架：React / Vue + TypeScript
- 状态管理：本地状态 + API 拉取

---

### 3.2 应用服务（Backend）

**职责**
- 提供 REST API（后台使用）
- 提供 WebSocket（展示端订阅）
- 维护当前比赛状态（Single Source of Truth）

**推荐技术栈**
- Node.js + Fastify / Express
- WebSocket：ws / socket.io
- 数据库存储：SQLite（单赛事）/ PostgreSQL（多赛事）

**核心能力**
- 权限校验（后台登录）
- 状态校验（字段完整性、锁定态保护）
- 广播控制（只在 Publish 时推送）

---

### 3.3 前端展示端（View Web）

**职责**
- 作为 OBS 浏览器源渲染画面
- 监听 WebSocket，实时更新 UI

**页面类型**
- /view/bp      → BP 全屏
- /view/overlay → 比赛中顶栏 + 侧栏
- /view/result  → 结算全屏
- /view/pause   → 技术暂停（可选）

**特性**
- 1080p 固定尺寸
- 可配置透明背景
- 无登录，仅订阅展示数据

---

## 4. 数据流设计

### 4.1 BP 数据流

```
数据员输入 BP
   ↓
后台保存 Draft
   ↓ (点击发布)
后端校验 + 存储
   ↓
WebSocket 广播 bp_update
   ↓
所有展示端实时渲染
```

### 4.2 结算数据流

```
比赛结束
   ↓
后台录入胜方/MVP
   ↓ (发布)
后端更新比分
   ↓
广播 result_update + score_update
   ↓
结算页面显示
```

---

## 5. 状态模型（关键）

### 5.1 比赛状态（Match）
- match_id
- best_of
- current_game_no
- scoreA / scoreB
- status（running / finished）

### 5.2 单局状态（GameState）

| 字段 | 说明 |
|----|----|
| game_no | 第几局 |
| bansA / bansB | ban 英雄数组 |
| picksA / picksB | 5v5 英雄选择 |
| published | 是否已发布 |
| locked | 是否锁定 |
| published_at | 发布时间 |

### 5.3 状态约束
- 未发布（Draft）：展示端不可见
- 已发布：展示端同步
- 已锁定：禁止修改 BP

---

## 6. 接口设计（概要）

### 6.1 REST API

| 方法 | 路径 | 用途 |
|----|----|----|
| POST | /api/login | 登录 |
| GET | /api/match/{id} | 获取当前比赛 |
| POST | /api/match/{id}/game/{n}/bp | 保存 BP 草稿 |
| POST | /api/match/{id}/game/{n}/publish | 发布 BP |
| POST | /api/match/{id}/game/{n}/lock | 锁定 BP |
| POST | /api/match/{id}/game/{n}/result | 发布结算 |

### 6.2 WebSocket 消息

| type | 说明 |
|----|----|
| bp_update | BP 数据更新 |
| result_update | 本局结算 |
| score_update | 大比分更新 |
| pause | 技术暂停状态 |

---

## 7. WebSocket 连接模型

- 连接方式：`wss://host/ws?match_id=xxx`
- 展示端连接后立即收到当前已发布状态
- 心跳机制：30s ping/pong

---

## 8. 容错与稳定性设计

### 8.1 网络异常
- 展示端断线重连后自动拉取最新状态
- 后台发布失败需有明确提示

### 8.2 误操作防护
- 发布 / 锁定二次确认
- 锁定态禁止写入
- 发布日志可回滚

### 8.3 OBS 容错
- 所有展示页面支持“无数据占位”
- 技术暂停页面作为兜底场景

---

## 9. 部署架构

### 9.1 单机部署（推荐）

```
[ Nginx ]
   │
   ├─ 静态前端（Admin + View）
   │
   └─ 反向代理
        │
        └─ Backend（API + WS）
```

- 适合班赛/单赛事
- 成本低，维护简单

### 9.2 扩展部署（可选）
- 前后端分离部署
- WebSocket 独立服务
- 多赛事并发支持

---

## 10. 安全与权限

- 后台接口需登录 Token
- 展示端只读、无鉴权
- 后台操作记录日志（操作人/时间/内容）

---

## 11. 与 OBS 的集成约定

- 所有展示页面 URL 固定
- 支持 transparent 参数
- 不依赖 Cookie / LocalStorage（避免 OBS 问题）

---

## 12. 验收标准（架构层）

- 后台发布 → 展示端 < 1s
- WebSocket 连接稳定（>2h 无断线）
- OBS 切换场景不丢状态
- 单点重启后可恢复最新状态

---

> 本架构文档已对齐 PRD 与推流 UI 设计，可直接作为：
> - 技术方案评审文档
> - 课程设计 / 项目答辩架构说明
> - 实际开发的技术蓝本

如需要，我可以下一步把 **接口文档（OpenAPI）** 或 **数据库 ER 设计** 直接补到画布里。

